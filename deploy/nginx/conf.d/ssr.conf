upstream backend {
    server app_worker_rw:8080 weight=2;
    server app_worker_ro1:8080;
    server app_worker_ro2:8080;
}

upstream backend_main {
    server app_worker_rw:8080;
}

upstream tmp_backend {
    server app_temp:8080;
}

map $request_method $upstream_location {
    GET backend;
    default backend_main;
}

upstream admin {
    server admin:8000;
}

upstream admin_static {
    server admin_static:80;
}

proxy_cache_path /var/nginx/cache levels=1:2 keys_zone=default_cache:10m max_size=1g;
#
# # Expires map
# map $sent_http_content_type $expires {
#     default                    off;
#     text/html                  epoch;
#     text/css                   max;
#     application/javascript     max;
#     ~/img/                      max;
#     ~font/                     max;
# }

server {
    listen 80;
    server_name ssr.test;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    ssl_certificate     /var/nginx/certs/cert.pem;
    ssl_certificate_key /var/nginx/certs/key.pem;
    server_name ssr.test;

    root /usr/share/nginx/html;

    gzip on;
    gzip_disable "msie6";

    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_min_length 256;
    gzip_types
      application/atom+xml
      application/geo+json
      application/javascript
      application/x-javascript
      application/json
      application/ld+json
      application/manifest+json
      application/rdf+xml
      application/rss+xml
      application/xhtml+xml
      application/xml
      font/eot
      font/otf
      font/ttf
      image/svg+xml
      text/css
      text/javascript
      text/plain
      text/xml;

    proxy_cache_key $scheme$request_method$host$request_uri;

    proxy_cache default_cache;
    proxy_cache_methods GET;
    proxy_cache_min_uses 2;

    proxy_cache_valid 10m;
    proxy_cache_valid 404 1m;


    location = /mirror1/api/v1 {
        proxy_set_header Host $http_host;
        proxy_pass_header Server;
        return 301 /mirror1/api/v1/swagger/index.html;
    }

    location ~ ^/mirror1/(.*)$ {
        proxy_no_cache 1;
        proxy_pass_header Server;
        proxy_set_header Host $http_host;
        proxy_pass http://tmp_backend/$1;
    }

    location = /status {
        proxy_no_cache 1;
        stub_status;
    }

    location /dj_static/ {
        proxy_set_header Host $http_host;
        proxy_pass http://admin_static;
    }

    location /admin/ {
        proxy_no_cache 1;
        proxy_set_header Host $http_host;
        proxy_pass http://admin;
    }

    location = /api/v1 {
        proxy_set_header Host $http_host;
        proxy_pass http://backend/api/v1/swagger/;
    }

    location /api/v1/ {
        proxy_no_cache 1;
        proxy_set_header Host $http_host;
        proxy_pass_header Server;
        proxy_pass http://$upstream_location;
    }

    location /test {
        try_files /index.html =404;
    }

    location = / {
        try_files /index.html =404;
    }
}
